{% extends 'simple_base.html' %}
{% load static %}

{% block title %}Become a Provider - Local Pro Connect{% endblock %}

{% block extra_css %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap');
  
  body {
    font-family: 'Inter', sans-serif;
  }
  
  .signup-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    background: linear-gradient(135deg, rgba(0, 76, 153, 0.95) 0%, rgba(0, 123, 255, 0.9) 100%),
                url('/static/assets/image/Gemini_Generated_Image_10go4k10go4k10go.png');
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    position: relative;
  }
  
  .signup-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 30% 40%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 70%, rgba(0, 123, 255, 0.15) 0%, transparent 50%);
    pointer-events: none;
  }
  
  .signup-card {
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(20px);
    border-radius: 24px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    padding: 50px;
    max-width: 800px;
    width: 100%;
    position: relative;
    z-index: 1;
    animation: slideUp 0.6s ease-out;
  }
  
  @keyframes slideUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .signup-header {
    text-align: center;
    margin-bottom: 35px;
  }
  
  .signup-header .icon-wrapper {
    width: 90px;
    height: 90px;
    background: linear-gradient(135deg, #004C99 0%, #007bff 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 25px;
    box-shadow: 0 8px 25px rgba(0, 76, 153, 0.4);
  }
  
  .signup-header .icon-wrapper i {
    font-size: 36px;
    color: white;
  }
  
  .signup-header h2 {
    background: linear-gradient(135deg, #004C99 0%, #007bff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-weight: 700;
    margin-bottom: 12px;
    font-size: 32px;
    font-family: 'Poppins', sans-serif;
  }
  
  .signup-header p {
    color: #555;
    font-size: 16px;
  }
  
  /* Progress Steps */
  .progress-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 40px;
    position: relative;
  }
  
  .progress-steps::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 0;
    right: 0;
    height: 3px;
    background: #e0e0e0;
    z-index: 0;
  }
  
  .progress-line {
    position: absolute;
    top: 20px;
    left: 0;
    height: 3px;
    background: linear-gradient(90deg, #004C99, #007bff);
    transition: width 0.3s ease;
    z-index: 1;
  }
  
  .step {
    flex: 1;
    text-align: center;
    position: relative;
    z-index: 2;
  }
  
  .step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e0e0e0;
    color: #999;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    font-weight: 600;
    transition: all 0.3s ease;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  
  .step.active .step-circle {
    background: linear-gradient(135deg, #004C99, #007bff);
    color: white;
    transform: scale(1.1);
  }
  
  .step.completed .step-circle {
    background: #28a745;
    color: white;
  }
  
  .step-label {
    font-size: 13px;
    color: #666;
    font-weight: 500;
  }
  
  .step.active .step-label {
    color: #004C99;
    font-weight: 600;
  }
  
  /* Form Steps */
  .form-step {
    display: none;
  }
  
  .form-step.active {
    display: block;
    animation: fadeIn 0.4s ease-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
  }
  
  .form-section-title {
    background: linear-gradient(135deg, #004C99, #007bff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: 'Poppins', sans-serif;
  }
  
  .form-section-title i {
    color: #007bff;
  }
  
  .form-label {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 8px;
    font-size: 14px;
    font-family: 'Poppins', sans-serif;
  }
  
  .form-label .required {
    color: #dc3545;
    font-weight: 700;
  }
  
  .form-control, .form-select {
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    padding: 12px 15px;
    font-size: 15px;
    transition: all 0.3s ease;
  }
  
  .form-control:focus, .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    outline: none;
  }
  
  .form-control.is-invalid, .form-select.is-invalid {
    border-color: #dc3545;
  }
  
  .invalid-feedback {
    font-size: 13px;
    margin-top: 5px;
    color: #dc3545;
  }
  
  .field-hint {
    font-size: 12px;
    color: #6c757d;
    margin-top: 4px;
    display: block;
  }
  
  .hidden {
    display: none !important;
  }
  
  /* Button Styles */
  .btn-navigation {
    display: flex;
    gap: 15px;
    margin-top: 30px;
  }
  
  .btn-prev, .btn-next, .btn-signup {
    padding: 14px 30px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 10px;
    border: none;
    transition: all 0.3s ease;
    font-family: 'Poppins', sans-serif;
    cursor: pointer;
  }
  
  .btn-prev {
    background: #6c757d;
    color: white;
    flex: 1;
  }
  
  .btn-prev:hover {
    background: #5a6268;
    transform: translateY(-2px);
  }
  
  .btn-next, .btn-signup {
    background: linear-gradient(135deg, #004C99 0%, #007bff 100%);
    color: white;
    flex: 2;
    box-shadow: 0 4px 15px rgba(0, 76, 153, 0.3);
  }
  
  .btn-next:hover, .btn-signup:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
  }
  
  .reassurance-text {
    background: #f8f9fa;
    border-left: 4px solid #007bff;
    padding: 15px;
    margin-top: 20px;
    border-radius: 8px;
    font-size: 14px;
    color: #555;
  }
  
  .reassurance-text i {
    color: #007bff;
    margin-right: 8px;
  }
  
  .row-fields {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }
  
  @media (max-width: 768px) {
    .row-fields {
      grid-template-columns: 1fr;
    }
    
    .signup-card {
      padding: 30px 20px;
    }
    
    .progress-steps {
      flex-wrap: wrap;
    }
    
    .step-label {
      font-size: 11px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="signup-container">
  <div class="signup-card">
    <div class="signup-header">
      <div class="icon-wrapper">
        <i class="fas fa-briefcase"></i>
      </div>
      <h2>Become a Provider</h2>
      <p>Join our network of trusted professionals and grow your business</p>
    </div>
    
    <!-- Progress Steps -->
    <div class="progress-steps">
      <div class="progress-line" id="progressLine"></div>
      <div class="step active" data-step="1">
        <div class="step-circle">1</div>
        <div class="step-label">Account</div>
      </div>
      <div class="step" data-step="2">
        <div class="step-circle">2</div>
        <div class="step-label">Service</div>
      </div>
      <div class="step" data-step="3">
        <div class="step-circle">3</div>
        <div class="step-label">Location</div>
      </div>
      <div class="step" data-step="4">
        <div class="step-circle">4</div>
        <div class="step-label">Profile</div>
      </div>
    </div>
    
    <!-- Global Form Errors -->
    {% if form.non_field_errors %}
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {% for error in form.non_field_errors %}
          <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
        {% endfor %}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endif %}
    
    <form method="post" enctype="multipart/form-data" novalidate id="providerRegistrationForm">
      {% csrf_token %}
      
      <!-- Step 1: Account Information -->
      <div class="form-step active" data-step="1">
        <div class="form-section-title">
          <i class="fas fa-user-circle"></i> Account Information
        </div>
        
        <div class="mb-3">
          <label class="form-label"><i class="fas fa-envelope me-2"></i>Email Address <span class="required">*</span></label>
          <input type="email" name="email" id="email" class="form-control {% if form.email.errors %}is-invalid{% endif %}" 
                 value="{{ form.email.value|default:'' }}" required placeholder="your.email@example.com">
          {% if form.email.errors %}
            <div class="invalid-feedback d-block">{% for error in form.email.errors %}{{ error }}{% endfor %}</div>
          {% endif %}
        </div>
        
        <div class="row-fields">
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-user me-2"></i>First Name</label>
            <input type="text" name="first_name" id="first_name" class="form-control {% if form.first_name.errors %}is-invalid{% endif %}" 
                   value="{{ form.first_name.value|default:'' }}" placeholder="Your first name">
            {% if form.first_name.errors %}
              <div class="invalid-feedback d-block">{% for error in form.first_name.errors %}{{ error }}{% endfor %}</div>
            {% endif %}
          </div>
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-user me-2"></i>Last Name</label>
            <input type="text" name="last_name" id="last_name" class="form-control {% if form.last_name.errors %}is-invalid{% endif %}" 
                   value="{{ form.last_name.value|default:'' }}" placeholder="Your last name">
            {% if form.last_name.errors %}
              <div class="invalid-feedback d-block">{% for error in form.last_name.errors %}{{ error }}{% endfor %}</div>
            {% endif %}
          </div>
        </div>
        
        <div class="row-fields">
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-lock me-2"></i>Password <span class="required">*</span></label>
            <input type="password" name="password1" id="password1" class="form-control {% if form.password1.errors %}is-invalid{% endif %}" 
                   required placeholder="At least 7 characters">
            <span class="field-hint">Must be at least 7 characters long</span>
            {% if form.password1.errors %}
              <div class="invalid-feedback d-block">{% for error in form.password1.errors %}{{ error }}{% endfor %}</div>
            {% endif %}
          </div>
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-lock me-2"></i>Confirm Password <span class="required">*</span></label>
            <input type="password" name="password2" id="password2" class="form-control {% if form.password2.errors %}is-invalid{% endif %}" 
                   required placeholder="Re-enter your password">
            {% if form.password2.errors %}
              <div class="invalid-feedback d-block">{% for error in form.password2.errors %}{{ error }}{% endfor %}</div>
            {% endif %}
          </div>
        </div>
        
        <input type="hidden" name="username" id="username" value="">
        
        <div class="btn-navigation">
          <button type="button" class="btn-next" onclick="nextStep(1)">
            Next <i class="fas fa-arrow-right ms-2"></i>
          </button>
        </div>
      </div>
      
      <!-- Step 2: Service Information -->
      <div class="form-step" data-step="2">
        <div class="form-section-title">
          <i class="fas fa-wrench"></i> Service Information
        </div>
        
        <div class="mb-3">
          <label class="form-label"><i class="fas fa-store me-2"></i>Company/Business Name</label>
          <input type="text" name="company_name" id="company_name" class="form-control {% if form.company_name.errors %}is-invalid{% endif %}" 
                 value="{{ form.company_name.value|default:'' }}" placeholder="Your Business Name">
          {% if form.company_name.errors %}
            <div class="invalid-feedback d-block">{% for error in form.company_name.errors %}{{ error }}{% endfor %}</div>
          {% endif %}
        </div>
        
        <div class="mb-3">
          <label class="form-label"><i class="fas fa-wrench me-2"></i>Service Type <span class="required">*</span></label>
          <select name="service_type" id="service_type" class="form-select {% if form.service_type.errors %}is-invalid{% endif %}" required>
            <option value="">-- Select a service --</option>
            <option value="plumbing" {% if form.service_type.value == 'plumbing' %}selected{% endif %}>Plumbing</option>
            <option value="electrical" {% if form.service_type.value == 'electrical' %}selected{% endif %}>Electrical</option>
            <option value="carpentry" {% if form.service_type.value == 'carpentry' %}selected{% endif %}>Carpentry</option>
            <option value="cleaning" {% if form.service_type.value == 'cleaning' %}selected{% endif %}>Cleaning</option>
            <option value="tutoring" {% if form.service_type.value == 'tutoring' %}selected{% endif %}>Tutoring</option>
            <option value="hvac" {% if form.service_type.value == 'hvac' %}selected{% endif %}>HVAC</option>
            <option value="roofing" {% if form.service_type.value == 'roofing' %}selected{% endif %}>Roofing</option>
            <option value="landscaping" {% if form.service_type.value == 'landscaping' %}selected{% endif %}>Landscaping</option>
            <option value="painting" {% if form.service_type.value == 'painting' %}selected{% endif %}>Painting</option>
            <option value="other" {% if form.service_type.value == 'other' %}selected{% endif %}>Other</option>
          </select>
          {% if form.service_type.errors %}
            <div class="invalid-feedback d-block">{% for error in form.service_type.errors %}{{ error }}{% endfor %}</div>
          {% endif %}
        </div>
        
        <div class="mb-3 hidden" id="otherServiceTypeContainer">
          <label class="form-label"><i class="fas fa-edit me-2"></i>Specify Service Type <span class="required">*</span></label>
          <input type="text" name="service_type_other" id="service_type_other" class="form-control {% if form.service_type_other.errors %}is-invalid{% endif %}" 
                 value="{{ form.service_type_other.value|default:'' }}" placeholder="e.g., Photography, Catering, etc.">
          {% if form.service_type_other.errors %}
            <div class="invalid-feedback d-block">{% for error in form.service_type_other.errors %}{{ error }}{% endfor %}</div>
          {% endif %}
        </div>
        
        <div class="row-fields">
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-phone me-2"></i>Phone Number</label>
            <input type="tel" name="phone" id="phone" class="form-control {% if form.phone.errors %}is-invalid{% endif %}" 
                   value="{{ form.phone.value|default:'' }}" placeholder="+237 6XX XXX XXX">
            {% if form.phone.errors %}
              <div class="invalid-feedback d-block">{% for error in form.phone.errors %}{{ error }}{% endfor %}</div>
            {% endif %}
          </div>
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-calendar-alt me-2"></i>Years of Experience</label>
            <input type="number" name="years_experience" id="years_experience" class="form-control {% if form.years_experience.errors %}is-invalid{% endif %}" 
                   value="{{ form.years_experience.value|default:'' }}" min="0" placeholder="e.g., 5">
            {% if form.years_experience.errors %}
              <div class="invalid-feedback d-block">{% for error in form.years_experience.errors %}{{ error }}{% endfor %}</div>
            {% endif %}
          </div>
        </div>
        
        <div class="btn-navigation">
          <button type="button" class="btn-prev" onclick="prevStep(2)">
            <i class="fas fa-arrow-left me-2"></i> Back
          </button>
          <button type="button" class="btn-next" onclick="nextStep(2)">
            Next <i class="fas fa-arrow-right ms-2"></i>
          </button>
        </div>
      </div>
      
      <!-- Step 3: Location Information -->
      <div class="form-step" data-step="3">
        <div class="form-section-title">
          <i class="fas fa-map-marker-alt"></i> Location Information
        </div>
        
        <div class="row-fields">
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-city me-2"></i>City <span class="required">*</span></label>
            <input type="text" name="city" id="city" class="form-control {% if form.city.errors %}is-invalid{% endif %}" 
                   value="{{ form.city.value|default:'' }}" required placeholder="e.g., Douala">
            {% if form.city.errors %}
              <div class="invalid-feedback d-block">{% for error in form.city.errors %}{{ error }}{% endfor %}</div>
            {% endif %}
          </div>
          <div class="mb-3">
            <label class="form-label"><i class="fas fa-map me-2"></i>Region <span class="required">*</span></label>
            <select name="state" id="state" class="form-select {% if form.state.errors %}is-invalid{% endif %}" required>
              <option value="">-- Select Region --</option>
              <option value="Adamawa" {% if form.state.value == 'Adamawa' %}selected{% endif %}>Adamawa</option>
              <option value="Centre" {% if form.state.value == 'Centre' %}selected{% endif %}>Centre</option>
              <option value="East" {% if form.state.value == 'East' %}selected{% endif %}>East</option>
              <option value="Far North" {% if form.state.value == 'Far North' %}selected{% endif %}>Far North</option>
              <option value="Littoral" {% if form.state.value == 'Littoral' %}selected{% endif %}>Littoral</option>
              <option value="North" {% if form.state.value == 'North' %}selected{% endif %}>North</option>
              <option value="Northwest" {% if form.state.value == 'Northwest' %}selected{% endif %}>Northwest</option>
              <option value="South" {% if form.state.value == 'South' %}selected{% endif %}>South</option>
              <option value="Southwest" {% if form.state.value == 'Southwest' %}selected{% endif %}>Southwest</option>
              <option value="West" {% if form.state.value == 'West' %}selected{% endif %}>West</option>
            </select>
            {% if form.state.errors %}
              <div class="invalid-feedback d-block">{% for error in form.state.errors %}{{ error }}{% endfor %}</div>
            {% endif %}
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label"><i class="fas fa-building me-2"></i>Business Address (Optional)</label>
          <input type="text" name="business_address" id="business_address" class="form-control {% if form.business_address.errors %}is-invalid{% endif %}" 
                 value="{{ form.business_address.value|default:'' }}" placeholder="Street address">
          {% if form.business_address.errors %}
            <div class="invalid-feedback d-block">{% for error in form.business_address.errors %}{{ error }}{% endfor %}</div>
          {% endif %}
        </div>
        
        <div class="mb-3">
          <label class="form-label"><i class="fas fa-mailbox me-2"></i>Postal Code (Optional)</label>
          <input type="text" name="zip_code" id="zip_code" class="form-control {% if form.zip_code.errors %}is-invalid{% endif %}" 
                 value="{{ form.zip_code.value|default:'' }}" placeholder="e.g., 237">
          {% if form.zip_code.errors %}
            <div class="invalid-feedback d-block">{% for error in form.zip_code.errors %}{{ error }}{% endfor %}</div>
          {% endif %}
        </div>
        
        <div class="btn-navigation">
          <button type="button" class="btn-prev" onclick="prevStep(3)">
            <i class="fas fa-arrow-left me-2"></i> Back
          </button>
          <button type="button" class="btn-next" onclick="nextStep(3)">
            Next <i class="fas fa-arrow-right ms-2"></i>
          </button>
        </div>
      </div>
      
      <!-- Step 4: Profile & Bio -->
      <div class="form-step" data-step="4">
        <div class="form-section-title">
          <i class="fas fa-info-circle"></i> Complete Your Profile (Optional)
        </div>
        
        <div class="mb-3">
          <label class="form-label"><i class="fas fa-camera me-2"></i>Profile Picture</label>
          <div id="imagePreviewContainer" class="mb-2" style="display: none;">
            <img id="imagePreview" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 12px; border: 2px solid #e0e0e0; object-fit: cover;">
            <button type="button" class="btn btn-sm btn-danger ms-2" onclick="clearImage()" style="vertical-align: top;">
              <i class="fas fa-times"></i> Remove
            </button>
          </div>
          <input type="file" name="profile_picture" id="profile_picture" class="form-control" accept="image/*" onchange="previewImage(event)">
          <span class="field-hint">Upload a professional photo (JPG, PNG - Max 5MB)</span>
        </div>
        
        <div class="mb-3">
          <label class="form-label"><i class="fas fa-file-alt me-2"></i>Business Bio / Description</label>
          <textarea name="bio" id="bio" class="form-control {% if form.bio.errors %}is-invalid{% endif %}" rows="5" 
                    placeholder="Tell clients about your business, expertise, and what makes you stand out...">{{ form.bio.value|default:'' }}</textarea>
          {% if form.bio.errors %}
            <div class="invalid-feedback d-block">{% for error in form.bio.errors %}{{ error }}{% endfor %}</div>
          {% endif %}
        </div>
        
        <div class="btn-navigation">
          <button type="button" class="btn-prev" onclick="prevStep(4)">
            <i class="fas fa-arrow-left me-2"></i> Back
          </button>
          <button type="submit" class="btn-signup">
            <i class="fas fa-rocket me-2"></i>Complete Registration
          </button>
        </div>
      </div>
    </form>
    
    <div class="signup-footer" style="text-align: center; margin-top: 25px; padding-top: 25px; border-top: 1px solid #e0e0e0;">
      <p style="color: #666; margin-bottom: 10px;">Already have an account? <a href="{% url 'accounts:login_page' %}" style="color: #007bff; font-weight: 600; text-decoration: none;">Sign in here</a></p>
      <p style="color: #666;">Not a professional? <a href="{% url 'accounts:register_user' %}" style="color: #007bff; font-weight: 600; text-decoration: none;">Register as User</a></p>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  let currentStep = 1;
  const totalSteps = 4;
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    updateProgressBar();
    setupServiceTypeToggle();
    setupFormValidation();
    
    // If there are form errors, show the step with errors
    const stepsWithErrors = document.querySelectorAll('.form-step .is-invalid');
    if (stepsWithErrors.length > 0) {
      const errorStep = stepsWithErrors[0].closest('.form-step');
      if (errorStep) {
        const stepNum = parseInt(errorStep.getAttribute('data-step'));
        goToStep(stepNum);
      }
    }
  });
  
  // Service Type Toggle for "Other" option
  function setupServiceTypeToggle() {
    const serviceTypeSelect = document.getElementById('service_type');
    const otherContainer = document.getElementById('otherServiceTypeContainer');
    const otherInput = document.getElementById('service_type_other');
    
    serviceTypeSelect.addEventListener('change', function() {
      if (this.value === 'other') {
        otherContainer.classList.remove('hidden');
        otherInput.setAttribute('required', 'required');
      } else {
        otherContainer.classList.add('hidden');
        otherInput.removeAttribute('required');
        otherInput.value = '';
      }
    });
    
    // Trigger on load if "other" is selected
    if (serviceTypeSelect.value === 'other') {
      otherContainer.classList.remove('hidden');
      otherInput.setAttribute('required', 'required');
    }
  }
  
  // Setup real-time form validation
  function setupFormValidation() {
    const form = document.getElementById('providerRegistrationForm');
    const inputs = form.querySelectorAll('input, select, textarea');
    
    inputs.forEach(input => {
      input.addEventListener('blur', function() {
        validateField(this);
      });
      
      input.addEventListener('input', function() {
        // Remove error state when user starts typing
        if (this.classList.contains('is-invalid')) {
          this.classList.remove('is-invalid');
          const feedback = this.nextElementSibling;
          if (feedback && feedback.classList.contains('invalid-feedback')) {
            feedback.style.display = 'none';
          }
        }
      });
    });
    
    // Password matching validation
    const password2 = document.getElementById('password2');
    password2.addEventListener('input', function() {
      const password1 = document.getElementById('password1');
      if (password1.value && password2.value && password1.value !== password2.value) {
        showFieldError(password2, 'Passwords do not match');
      }
    });
  }
  
  // Validate individual field
  function validateField(field) {
    const value = field.value.trim();
    let isValid = true;
    let errorMessage = '';
    
    // Check required fields
    if (field.hasAttribute('required') && !value) {
      isValid = false;
      errorMessage = 'This field is required';
    }
    
    // Email validation
    if (field.type === 'email' && value) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(value)) {
        isValid = false;
        errorMessage = 'Please enter a valid email address';
      }
    }
    
    // Password validation (min 7 characters)
    if (field.id === 'password1' && value && value.length < 7) {
      isValid = false;
      errorMessage = 'Password must be at least 7 characters long';
    }
    
    // Password confirmation
    if (field.id === 'password2' && value) {
      const password1 = document.getElementById('password1').value;
      if (value !== password1) {
        isValid = false;
        errorMessage = 'Passwords do not match';
      }
    }
    
    // Phone validation (basic)
    if (field.id === 'phone' && value) {
      const phoneRegex = /^[\d\s\+\-\(\)]+$/;
      if (!phoneRegex.test(value)) {
        isValid = false;
        errorMessage = 'Please enter a valid phone number';
      }
    }
    
    // Years experience validation
    if (field.id === 'years_experience' && value) {
      const years = parseInt(value);
      if (isNaN(years) || years < 0) {
        isValid = false;
        errorMessage = 'Please enter a valid number (0 or greater)';
      }
    }
    
    if (!isValid) {
      showFieldError(field, errorMessage);
    } else {
      clearFieldError(field);
    }
    
    return isValid;
  }
  
  // Show field error
  function showFieldError(field, message) {
    field.classList.add('is-invalid');
    
    // Find or create error message element
    let feedback = field.parentElement.querySelector('.invalid-feedback');
    if (!feedback) {
      feedback = document.createElement('div');
      feedback.className = 'invalid-feedback d-block';
      field.parentElement.appendChild(feedback);
    }
    
    feedback.textContent = message;
    feedback.style.display = 'block';
  }
  
  // Clear field error
  function clearFieldError(field) {
    field.classList.remove('is-invalid');
    const feedback = field.parentElement.querySelector('.invalid-feedback');
    if (feedback) {
      feedback.style.display = 'none';
    }
  }
  
  // Validate current step before proceeding
  function validateStep(stepNumber) {
    const step = document.querySelector(`.form-step[data-step="${stepNumber}"]`);
    const fields = step.querySelectorAll('input[required], select[required], textarea[required]');
    let isValid = true;
    let errors = [];
    
    fields.forEach(field => {
      // Skip hidden fields
      if (field.offsetParent === null) return;
      
      if (!validateField(field)) {
        isValid = false;
        const label = field.parentElement.querySelector('label');
        const fieldName = label ? label.textContent.replace('*', '').trim() : field.name;
        errors.push(fieldName);
      }
    });
    
    if (!isValid) {
      // Show error summary
      showStepErrorSummary(stepNumber, errors);
      
      // Focus on first error field
      const firstError = step.querySelector('.is-invalid');
      if (firstError) {
        firstError.focus();
      }
    }
    
    return isValid;
  }
  
  // Show step error summary
  function showStepErrorSummary(stepNumber, errors) {
    const step = document.querySelector(`.form-step[data-step="${stepNumber}"]`);
    
    // Remove existing summary
    const existingSummary = step.querySelector('.step-error-summary');
    if (existingSummary) {
      existingSummary.remove();
    }
    
    // Create error summary
    const summary = document.createElement('div');
    summary.className = 'alert alert-danger step-error-summary';
    summary.style.marginBottom = '20px';
    summary.innerHTML = `
      <i class="fas fa-exclamation-triangle me-2"></i>
      <strong>Please fix the following errors before continuing:</strong>
      <ul style="margin: 10px 0 0 20px; padding: 0;">
        ${errors.map(err => `<li>${err}</li>`).join('')}
      </ul>
    `;
    
    step.insertBefore(summary, step.firstChild.nextSibling);
    
    // Scroll to top of step
    step.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
  
  // Navigate to next step
  function nextStep(fromStep) {
    if (!validateStep(fromStep)) {
      return;
    }
    
    // Generate username from email if not set (Step 1)
    if (fromStep === 1) {
      const email = document.getElementById('email').value;
      const usernameField = document.getElementById('username');
      if (email && !usernameField.value) {
        usernameField.value = email.split('@')[0];
      }
    }
    
    if (currentStep < totalSteps) {
      currentStep++;
      goToStep(currentStep);
    }
  }
  
  // Navigate to previous step
  function prevStep(fromStep) {
    if (currentStep > 1) {
      currentStep--;
      goToStep(currentStep);
    }
  }
  
  // Go to specific step
  function goToStep(stepNumber) {
    currentStep = stepNumber;
    
    // Update form steps
    document.querySelectorAll('.form-step').forEach(step => {
      step.classList.remove('active');
    });
    document.querySelector(`.form-step[data-step="${stepNumber}"]`).classList.add('active');
    
    // Update progress indicators
    document.querySelectorAll('.step').forEach(step => {
      const stepNum = parseInt(step.getAttribute('data-step'));
      step.classList.remove('active', 'completed');
      
      if (stepNum === stepNumber) {
        step.classList.add('active');
      } else if (stepNum < stepNumber) {
        step.classList.add('completed');
      }
    });
    
    updateProgressBar();
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  
  // Update progress bar
  function updateProgressBar() {
    const progressLine = document.getElementById('progressLine');
    const percentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
    progressLine.style.width = percentage + '%';
  }
  
  // Form submission validation
  document.getElementById('providerRegistrationForm').addEventListener('submit', function(e) {
    // Validate all steps
    let allValid = true;
    for (let i = 1; i <= totalSteps; i++) {
      if (!validateStep(i)) {
        allValid = false;
        goToStep(i);
        e.preventDefault();
        return false;
      }
    }
    
    if (!allValid) {
      e.preventDefault();
      return false;
    }
  });
  
  // Image preview function
  function previewImage(event) {
    const file = event.target.files[0];
    const previewContainer = document.getElementById('imagePreviewContainer');
    const preview = document.getElementById('imagePreview');
    
    if (file) {
      // Validate file size (5MB max)
      if (file.size > 5 * 1024 * 1024) {
        alert('Image size must be less than 5MB');
        event.target.value = '';
        return;
      }
      
      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        event.target.value = '';
        return;
      }
      
      // Show preview
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        previewContainer.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  }
  
  // Clear image function
  function clearImage() {
    const fileInput = document.getElementById('profile_picture');
    const previewContainer = document.getElementById('imagePreviewContainer');
    const preview = document.getElementById('imagePreview');
    
    fileInput.value = '';
    preview.src = '';
    previewContainer.style.display = 'none';
  }
</script>
{% endblock %}
