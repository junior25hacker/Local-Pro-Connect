{% extends 'base.html' %}
{% load static %}

{% block title %}Confirm Request Decline{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/rejection_modal.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h1 class="card-title text-danger mb-4">
                        <i class="fas fa-times-circle"></i> Decline Request
                    </h1>

                    <div class="alert alert-info">
                        <strong>Request Details:</strong>
                        <p><strong>Request ID:</strong> #{{ service_request.id }}</p>
                        <p><strong>From:</strong> {{ service_request.user.get_full_name|default:service_request.user.username }}</p>
                        <p><strong>Service Type:</strong> {{ service_request.provider_name }}</p>
                        <p><strong>Description:</strong> {{ service_request.description }}</p>
                        {% if service_request.date_time %}
                        <p><strong>Requested Date/Time:</strong> {{ service_request.date_time|date:"M d, Y H:i" }}</p>
                        {% endif %}
                        {% if service_request.price_range %}
                        <p><strong>Price Range:</strong> {{ service_request.price_range }}</p>
                        {% endif %}
                        {% if service_request.urgent %}
                        <p><span class="badge bg-danger">URGENT</span></p>
                        {% endif %}
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> The customer will be notified that you've declined this request. 
                        They may contact other service providers.
                    </div>

                    <div class="d-grid gap-2 d-sm-flex justify-content-center">
                        <button type="button" class="btn btn-danger btn-lg" id="declineBtn">
                            <i class="fas fa-times-circle"></i> Decline Request
                        </button>
                        <a href="/" class="btn btn-secondary btn-lg">
                            <i class="fas fa-arrow-left"></i> Go Back
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rejection Modal -->
<div class="modal-overlay" id="rejectionModalOverlay" style="display: none;">
    <!-- Modal Container -->
    <div class="rejection-modal" id="rejectionModal">
        <!-- Modal Header -->
        <div class="modal-header">
            <div class="modal-header-content">
                <div class="modal-icon-wrapper">
                    <i class="fas fa-times-circle"></i>
                </div>
                <h2 class="modal-title">Reject Service Request</h2>
            </div>
            <button class="modal-close-btn" id="closeModalBtn" aria-label="Close modal">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="modal-body">
            <form method="POST" id="rejectionForm" class="rejection-form" action="{% url 'requests:provider_decision' service_request.id 'decline' token %}">
                {% csrf_token %}
                
                <!-- Instructions -->
                <p class="modal-description">
                    Please select a reason for rejecting this service request. Your feedback helps us improve our matching system.
                </p>

                <!-- Rejection Reasons Section -->
                <div class="form-section">
                    <label class="section-label">
                        <i class="fas fa-list-check"></i>
                        Select Rejection Reason <span class="required">*</span>
                    </label>
                    
                    <div class="reason-options" id="reasonOptions">
                        <!-- Distance Option -->
                        <div class="reason-card" data-reason="distance">
                            <input type="radio" name="rejection_reason" value="distance" id="reason_distance" required>
                            <label for="reason_distance" class="reason-label">
                                <div class="reason-icon">
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                                <div class="reason-content">
                                    <h4 class="reason-title">Distance</h4>
                                    <p class="reason-subtitle">Location is too far from my service area</p>
                                </div>
                                <div class="reason-checkmark">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </label>
                        </div>

                        <!-- Price Option -->
                        <div class="reason-card" data-reason="price">
                            <input type="radio" name="rejection_reason" value="price" id="reason_price" required>
                            <label for="reason_price" class="reason-label">
                                <div class="reason-icon">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="reason-content">
                                    <h4 class="reason-title">Price</h4>
                                    <p class="reason-subtitle">Budget doesn't match my pricing</p>
                                </div>
                                <div class="reason-checkmark">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </label>
                        </div>

                        <!-- Time Option -->
                        <div class="reason-card" data-reason="time">
                            <input type="radio" name="rejection_reason" value="time" id="reason_time" required>
                            <label for="reason_time" class="reason-label">
                                <div class="reason-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="reason-content">
                                    <h4 class="reason-title">Time</h4>
                                    <p class="reason-subtitle">Schedule doesn't work for me</p>
                                </div>
                                <div class="reason-checkmark">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </label>
                        </div>

                        <!-- Other Option -->
                        <div class="reason-card" data-reason="other">
                            <input type="radio" name="rejection_reason" value="other" id="reason_other" required>
                            <label for="reason_other" class="reason-label">
                                <div class="reason-icon">
                                    <i class="fas fa-ellipsis-h"></i>
                                </div>
                                <div class="reason-content">
                                    <h4 class="reason-title">Other</h4>
                                    <p class="reason-subtitle">Different reason not listed above</p>
                                </div>
                                <div class="reason-checkmark">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Error Message -->
                    <div class="error-message" id="reasonError" style="display: none;">
                        <i class="fas fa-exclamation-circle"></i>
                        Please select a rejection reason before continuing.
                    </div>
                </div>

                <!-- Selected Reason Display -->
                <div class="selected-reason-display" id="selectedReasonDisplay" style="display: none;">
                    <div class="selected-reason-content">
                        <i class="fas fa-info-circle"></i>
                        <span class="selected-reason-text">
                            You selected: <strong id="selectedReasonText"></strong>
                        </span>
                    </div>
                </div>

                <!-- Description Section -->
                <div class="form-section description-section" id="descriptionSection" style="display: none;">
                    <label for="rejection_description" class="section-label">
                        <i class="fas fa-comment-dots"></i>
                        Additional Details <span class="optional">(Optional)</span>
                    </label>
                    <textarea 
                        name="rejection_description" 
                        id="rejection_description" 
                        class="description-textarea"
                        rows="4"
                        placeholder="Please provide more details about your reason for rejection. This information helps us improve our service and may be shared with the customer."
                        maxlength="500"
                    ></textarea>
                    <div class="character-count">
                        <span id="charCount">0</span>/500 characters
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">
                        <i class="fas fa-arrow-left"></i>
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-danger" id="submitBtn" disabled>
                        <i class="fas fa-paper-plane"></i>
                        Submit Rejection
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Integration script for confirm_decline page
    document.addEventListener('DOMContentLoaded', function() {
        const declineBtn = document.getElementById('declineBtn');
        const modalOverlay = document.getElementById('rejectionModalOverlay');
        const rejectionForm = document.getElementById('rejectionForm');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        
        // Show modal when decline button is clicked
        declineBtn.addEventListener('click', function() {
            modalOverlay.style.display = 'flex';
            // Focus first reason option for accessibility
            const firstReason = document.getElementById('reason_distance');
            if (firstReason) {
                setTimeout(() => firstReason.focus(), 100);
            }
        });
        
        // Hide modal when close button is clicked
        closeModalBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Are you sure you want to cancel? Your changes will be lost.')) {
                modalOverlay.style.display = 'none';
            }
        });
        
        // Hide modal when cancel button is clicked
        cancelBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Are you sure you want to cancel? Your changes will be lost.')) {
                modalOverlay.style.display = 'none';
            }
        });
        
        // Close modal when clicking overlay
        modalOverlay.addEventListener('click', function(e) {
            if (e.target === modalOverlay) {
                if (confirm('Are you sure you want to cancel? Your changes will be lost.')) {
                    modalOverlay.style.display = 'none';
                }
            }
        });
        
        // Handle Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modalOverlay.style.display === 'flex') {
                if (confirm('Are you sure you want to cancel? Your changes will be lost.')) {
                    modalOverlay.style.display = 'none';
                }
            }
        });
    });
</script>
<script src="{% static 'js/rejection_modal.js' %}"></script>
{% endblock %}
